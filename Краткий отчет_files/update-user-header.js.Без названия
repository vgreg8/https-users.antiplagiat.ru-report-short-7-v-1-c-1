$(document).ready(function(){function a(){e(),l>0?d():($(".tariff-validity").html(""),$(".tariff-validity").hide()),l>0&&m.length>0?g():$(".tariff-validity").attr("data-hasqtip")&&$(".tariff-validity").qtip("destroy")}function b(){j||(j=!0,$.ajax({type:"GET",url:"/api/billing/tariffinfo",dataType:"json",timeout:6e4,success:function(a){a&&c(a)},complete:function(a,b){j=!1}}))}function c(b){if(null!=b){$(".user-info-tariff").find(".tariff-current strong").text(b.TariffDisplayName),$(".user-info-tariff").find(".tariff-current").toggleClass("free",b.IsFree),$(".user-info-balance").find(".checks-current").toggleClass("free",b.IsFree);var c=$.localize("Change","~/js/common/updateUserHeader.js");$(".user-info-tariff").find(".tariff-edit > a").text(c),$(".user-info-tariff").find(".tariff-edit > a").attr({title:c});var d="";if(l=b.RemainingDurationMs,m=b.TariffsDetails||[],n=b.ChecksPeriodLimit||{},o=b.ChecksDisabledDetails||null,$(".user-info-balance").find(".checks-current i").qtip("destroy"),null!=o)d="<strong>"+$.localize("Unavailable","~/js/common/updateUserHeader.js")+'</strong>&nbsp;<i class="info"></i>';else if(b.IsFree){if(n.hasOwnProperty("ChecksCount")&&n.hasOwnProperty("PeriodInMinutes")){var e=[n.ChecksCount,n.PeriodInMinutes];d="<strong>"+$.localize("Сhecks Demo limit","~/js/common/updateUserHeader.js",e)+'</strong>&nbsp;<i class="info"></i>'}}else d='<span id="user-info-checks-left">'+b.ChecksRemaining+'</span>&nbsp;<i class="clock"></i>&nbsp;<span class="tariff-validity">'+h(l)+"</span>";$(".user-info-balance").find(".checks-current").html(d),g(),a()}}function d(){if(isNaN(l)||l<0)$(".tariff-validity").html(""),$(".tariff-validity").hide();else{var a=h(l);$(".tariff-validity").html(a),$(".tariff-validity").show()}var c=1e3*(60-(new Date).getSeconds());l-=c,k=l>0?setTimeout(d,c):setTimeout(b,l+c+1)}function e(){null!=k&&(clearTimeout(k),k=null)}function f(){var a=$(".user-info-tariff .tariff-current").qtip({content:{text:""},style:{classes:"qtip-ux qtip-version ap-header-qtip qtip-tariff-list",tip:{corner:"top center",mimic:"center top",width:12}},position:{my:"top center",at:"bottom center",target:$(".user-info-tariff .tariff-current i"),viewport:$(".header-inner"),adjust:{y:3,method:"shift none"}},show:{event:"mouseover"},events:{show:function(b,c){c.target.hasClass("free")?(setYMMainCounter("tariff_hint_free"),setGAMainCounter("top_navigation","tariff_hint_free"),a.qtip("api").set("content.text",$.localize("Demo tariff warning message","~/js/common/updateUserHeader.js"))):(setYMMainCounter("tariff_hint_full"),setGAMainCounter("top_navigation","tariff_hint_full"),a.qtip("option","content.text",$.localize("Loading...","~/js/common/updateUserHeader.js")),$.ajax({type:"GET",url:"/api/billing/tariffs",dataType:"json",timeout:6e4,success:function(b){if(b){var c=b.UserTariffs;for($tariffTipContent=$.localize("{0}Your rates:{1}","~/js/common/updateUserHeader.js",["<b>","</b>"]),i=0;i<c.length;i++){var d=!("Demo"!=c[i].DisplayName||!b.hasOwnProperty("ChecksDisabledDetails")||$.isEmptyObject(b.ChecksDisabledDetails));d||($tariffTipContent+="<br>"+c[i].DisplayName)}a.qtip("option","content.text",$tariffTipContent)}},error:function(b){401==b.status?window.location.href="/":a.qtip("option","content.text",$.localize("Error","~/js/common/updateUserHeader.js"))}}))}}})}function g(){var a="";if(null!=o){var b=showShortDate(new Date(Date.parse(o.From))),c=showShortDate(new Date(Date.parse(o.To)));a=$.localize("Demo tariff is not available from {0} to {1}","~/js/common/updateUserHeader.js",[b,c])}else if($(".user-info-balance .checks-current").hasClass("free")){if(n.hasOwnProperty("ChecksCount")&&n.hasOwnProperty("PeriodInMinutes")){var d=[n.ChecksCount,n.PeriodInMinutes];a=$.localize("Сhecks Demo limit tip","~/js/common/updateUserHeader.js",d)}}else a=$.map(m,function(a){var b=showShortDate(new Date(Date.parse(a.EndDate))),c=a.ChecksRemaining||0,d=$.localize("{0} check expires {1}, {0} checks expire {1}, {0} checks expire {1}","~/js/common/updateUserHeader.js",[c,b]);return"<p>"+getNumEnding(c,d.split(", "))+"</p>"}).join("\n");$(".user-info-balance .checks-current").qtip({content:{text:a},style:{classes:"qtip-ux qtip-version ap-header-qtip",tip:{corner:"top center",mimic:"center top",width:12}},position:{my:"top center",at:"bottom center",target:$(".user-info-balance .checks-current i"),viewport:$(".user-info-inner"),adjust:{y:3,method:"shift none"}},show:{event:"mouseover"},events:{show:function(a,b){b.target.hasClass("free")?(setYMMainCounter("checks_hint_free"),setGAMainCounter("top_navigation","checks_hint_free")):(setYMMainCounter("checks_hint_full"),setGAMainCounter("top_navigation","checks_hint_full"))}}})}function h(a){var b="",c=Math.floor(a/864e5);a-=864e5*c;var d=Math.floor(a/36e5);a-=36e5*d;var e=Math.floor(a/6e4);return a-=6e4*e,c>0&&(b+=c+$.localize("d","~/js/common/updateUserHeader.js")),c<7&&(b+=" "+d+$.localize("h","~/js/common/updateUserHeader.js")),c<=0&&(b+=" "+e+$.localize("m","~/js/common/updateUserHeader.js")),$.trim(b)}var j=!1,k=null,l=parseInt($("#endTariffTime").val()),m=[],n={},o=null;$("#endTariffTime").attr("data-details")&&(m=$("#endTariffTime").data("details")||[],$("#endTariffTime").removeAttr("data-details")),$("#checksPeriodLimit").length>0&&(n=$("#checksPeriodLimit").data("checks")||{},$("#checksPeriodLimit").remove()),$("#checksDisabledDetails").length>0&&(o=$("#checksDisabledDetails").data("period")||null,$("#checksDisabledDetails").remove()),f(),g(),a(),$(document).on("userInfoUpdated",function(a){b()})});